<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CrossCTF Finals 2018 : GruffyBear (Pwn) | Enigmatrix</title>
    <meta name="description" content="Enigmatrix&#39;s Site">
    <link rel="icon" href="/favicon.png">
    
    <link rel="preload" href="/assets/css/0.styles.00ae9f8b.css" as="style"><link rel="preload" href="/assets/js/app.e91e0d74.js" as="script"><link rel="preload" href="/assets/js/12.e9130249.js" as="script"><link rel="preload" href="/assets/js/3.0adb0de5.js" as="script"><link rel="preload" href="/assets/js/2.e61d4284.js" as="script"><link rel="preload" href="/assets/js/8.d74ac80a.js" as="script"><link rel="preload" href="/assets/js/7.646cabab.js" as="script"><link rel="preload" href="/assets/js/17.aede9271.js" as="script"><link rel="preload" href="/assets/js/11.e9277445.js" as="script"><link rel="prefetch" href="/assets/js/10.fb5ae33a.js"><link rel="prefetch" href="/assets/js/13.3697ebdc.js"><link rel="prefetch" href="/assets/js/14.87011aa2.js"><link rel="prefetch" href="/assets/js/15.6a1c42f4.js"><link rel="prefetch" href="/assets/js/16.cff03335.js"><link rel="prefetch" href="/assets/js/18.11dd9f7a.js"><link rel="prefetch" href="/assets/js/19.fafb1f9b.js"><link rel="prefetch" href="/assets/js/20.0b83ae72.js"><link rel="prefetch" href="/assets/js/4.528702b0.js"><link rel="prefetch" href="/assets/js/5.c25507f6.js"><link rel="prefetch" href="/assets/js/6.851e4507.js"><link rel="prefetch" href="/assets/js/9.a24c9782.js">
    <link rel="stylesheet" href="/assets/css/0.styles.00ae9f8b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Enigmatrix</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Profile</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/projects/" class="nav-link">Projects</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Profile</a></div><div class="nav-item"><a href="/blog/" class="nav-link">Blog</a></div><div class="nav-item"><a href="/projects/" class="nav-link">Projects</a></div> <!----></nav>  <!----> </aside> <main class="page"><div class="content default"> <div id="post-head" slot="page-top" data-v-bd082cac><p class="post-time" data-v-bd082cac>Tue Jan 15 14:59:08 +08 2019</p> <div data-v-bd082cac><h1 data-v-bd082cac>CrossCTF Finals 2018 : GruffyBear (Pwn)</h1></div> <h3 class="post-desc" data-v-bd082cac>First Post to test all the weird and wonky stuff</h3> <div class="flex-grid" data-v-bd082cac><div class="card tag" data-v-bd082cac><h4 data-v-bd082cac><a href="/tag/pwn.html" data-v-bd082cac>pwn</a></h4></div><div class="card tag" data-v-bd082cac><h4 data-v-bd082cac><a href="/tag/crossctf.html" data-v-bd082cac>crossctf</a></h4></div><div class="card tag" data-v-bd082cac><h4 data-v-bd082cac><a href="/tag/reverse.html" data-v-bd082cac>reverse</a></h4></div><div class="card tag" data-v-bd082cac><h4 data-v-bd082cac><a href="/tag/osilayer8.html" data-v-bd082cac>osilayer8</a></h4></div></div></div> <div><div class="content default"><h3 id="first-blood-by-n0x10u5-g4s3s"><a href="#first-blood-by-n0x10u5-g4s3s" aria-hidden="true" class="header-anchor">#</a> First Blood by : N0X10U5 G4S3S</h3> <blockquote><p>There's something fishy about this Build-A-Bear workshop...</p> <p>nc ctf.pwn.sg 4002</p> <p>Creator - amon (@nn_amon)</p></blockquote> <h2 id="static-analysis"><a href="#static-analysis" aria-hidden="true" class="header-anchor">#</a> Static Analysis</h2> <p>Running <code>file gruffybear</code> gives:</p> <div class="language- extra-class"><pre class="language-text"><code>gruffybear: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter ld-2.23.so, for GNU/Linux 2.6.32, BuildID[sha1]=405edd7cd41e309d1cab442ffc6a6dad8e782908, not stripped
</code></pre></div><p>The code:</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-24h]</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-20h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
  <span class="token function">alarm</span><span class="token punctuation">(</span><span class="token number">0x3Cu</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
LABEL_2<span class="token punctuation">:</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">print_banner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> v4 <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
          <span class="token function">build_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_2<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
          <span class="token function">select_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_2<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>
          <span class="token function">delete_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_2<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>
          <span class="token function">print_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_2<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token punctuation">:</span>
          <span class="token function">add_comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_2<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">6</span><span class="token punctuation">:</span>
          <span class="token function">print_comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_2<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">7</span><span class="token punctuation">:</span>
          <span class="token function">destruction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v4 <span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Nothing to do.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>main()</code> does some setup like turning off buffering, and calling <code>alarm(0x3cu)</code>. This sets us on a time limit, after which the program will crash.</p> <blockquote><p>Make sure to <code>nop</code> the call to <code>alarm()</code> using your tool. e.g. in <code>radare2</code> you would go to the address of the call then <code>wx 9090909090</code> .</p></blockquote> <p>In a loop, we print a banner, then get input. Based on the input, we call functions. This is a typical menu-based cli program.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> __int64 <span class="token function">build_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v0<span class="token punctuation">;</span> <span class="token comment">// rbp</span>
  bear <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+7h] [rbp-21h]</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-20h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> num_bears<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> num_bears<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">12</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v3 <span class="token operator">=</span> <span class="token string">&quot;SUNIATRETNE&quot;</span><span class="token punctuation">;</span>
    <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Here we are now... &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v3<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">!=</span> buf <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">--</span>v3 <span class="token operator">==</span> <span class="token string">&quot;nt&quot;</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        admin_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    v1 <span class="token operator">=</span> <span class="token punctuation">(</span>bear <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1uLL</span><span class="token punctuation">,</span> <span class="token number">0xB8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bears<span class="token punctuation">[</span>v0<span class="token punctuation">]</span> <span class="token operator">=</span> v1<span class="token punctuation">;</span>
    <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Bear Name: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token number">0x1FuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Bear ID: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%x&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token operator">-&gt;</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Bear Age: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token operator">-&gt;</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Bear Description: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v1<span class="token operator">-&gt;</span>description<span class="token punctuation">,</span> <span class="token number">0x80uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v1<span class="token operator">-&gt;</span>free_function <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>free<span class="token punctuation">;</span>
    v1<span class="token operator">-&gt;</span>self_destruct_device_ptr <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>self_destruct_device<span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Bear created!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>num_bears<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The typical functionality of <code>build_bear()</code> is to allocate <code>0xb8</code> size of memory using malloc() then initialize it using user-provided values, then set the global <code>bears</code> array's last unused element to our the address of the bear (<code>bears[v0]=v1</code>, where v0 is the ```num_bears). The 'bear' struct seems to as follows:</p> <div class="language- extra-class"><pre class="language-text"><code>struct bear{
    char name[32];
    int id;
    int age;
    char desc[128];
    void* free_ptr;
    void* self_destruct_device_ptr;
}
</code></pre></div><p>Once we have 13 bears built already, we enter some sort of secret section, which lets us set <code>admin_enabled</code> to 1, as long as we satisfy some checks. In short, what the checks really want are the characters of &quot;SUNIATRETNE&quot; in reverse.</p> <blockquote><p>IDA Pro sometimes goofs up its decompiler. What the <code>v3-- == &quot;nt&quot;</code> really means is <code>v3-- == (__int64)SUNIATRETNE&quot;-1</code>, or whether v3-- points to the byte before the &quot;S&quot;.</p></blockquote> <blockquote><p>The above can be simplified to</p></blockquote> <div class="language-c extra-class"><pre class="language-c"><code>v3 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">&quot;SUNIATRETNE&quot;</span><span class="token punctuation">;</span> <span class="token comment">// v3 is a POINTER</span>
<span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Here we are now... &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">!=</span> buf <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">--</span>v3 <span class="token operator">==</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token string">&quot;SUNIATRETNE&quot;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        admin_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>On to the next function ...</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> __int64 <span class="token function">select_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-14h]</span>
  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-10h]</span>

  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Selection: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v1 <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> v1 <span class="token operator">&lt;</span> <span class="token operator">*</span>num_bears <span class="token punctuation">)</span>
    selected_bear <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>bears<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Not enough bears.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The program reads in a number, lets say <code>a</code>. If it is not negative and if it is lesser than num_bears, selected_bear will now have a copy of the pointer to the bear at index <code>a</code>. Else, it prints out &quot;Not enough bears&quot;.</p> <blockquote><p><code>(v1 &amp; 0x800000000)==0</code> means <code>first bit of v1 == 0</code>, and the first bit of a integer is its sign bit, according to 2s complement notation.</p></blockquote> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">delete_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>selected_bear <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;No bear selected!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Deleting [%s]...\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>selected_bear<span class="token operator">-&gt;</span>free_function <span class="token operator">==</span> <span class="token operator">&amp;</span>free <span class="token punctuation">)</span>
    <span class="token function">free</span><span class="token punctuation">(</span>selected_bear<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Deleted!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The function <code>free()'s</code> the pointer in <code>selected_bear</code>, as long as the <code>free_function</code> still points to free.</p> <blockquote><p>The <code>selected_bear</code> is not zero'ed out.
<br>The <code>bears[idx]</code> is not zero'ed out.
<br><strong>This challenge is a typical UAF challenge.</strong> <br><code>num_bears</code> is not decremented</p></blockquote> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">print_bear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  __int64 v0<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  __int64 v1<span class="token punctuation">;</span> <span class="token comment">// rdx</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>selected_bear <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;No bear selected!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>art<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;You have selected: [%s]\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>selected_bear<span class="token operator">-&gt;</span>id<span class="token punctuation">;</span>
  <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;It's ID is %x\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>selected_bear<span class="token operator">-&gt;</span>age<span class="token punctuation">;</span>
  <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;It's AGE is %d\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;It's DESCRIPTION is %s\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This function just prints out information about the <code>selected_bear</code>.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">unsigned</span> __int64 <span class="token function">add_comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nbytes<span class="token punctuation">;</span>

  <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;How long should the comment be: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  comment <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span>nbytes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_printf_chk</span><span class="token punctuation">(</span><span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token string">&quot;Comment: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> comment<span class="token punctuation">,</span> nbytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Here comes the main tool to exploit the UAF vulneraribility. This function reads in a number then calls <code>calloc(nbytes+1, 1)</code>, which is the same as <code>malloc(nbytes+1)</code>.</p> <blockquote><p>If we <code>delete_bear()</code> then <code>add_comment()</code> of size <code>0xb8-1</code>, we can control ALL OF THE BEAR, including its <code>self_destruct_device_ptr</code>, which will be called later on...
<br> <em>Insert evil laugh here</em></p></blockquote> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">print_comment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// eax</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> comment <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;No&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Pretty basic, prints the comment or prints &quot;No&quot; if theres no comment.</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">destruction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// eax</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>admin_enabled <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Nothing to do&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">signed</span> <span class="token keyword">int</span><span class="token punctuation">)</span>selected_bear<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> selected_bear <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span>selected_bear<span class="token operator">-&gt;</span>self_destruct_device_ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>num_bears<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If <code>admin_enabled</code> is true and <code>selected_bear</code> is valid,
we can execute <code>selected_bear</code>'s <code>self_destruct_device_ptr</code></p> <h2 id="solution"><a href="#solution" aria-hidden="true" class="header-anchor">#</a> Solution</h2> <p>As mentioned earlier, this is a typical UAF challenge. The obvious steps so far are:</p> <ol><li>Build Bear
<ol><li>Put arbitrary data</li></ol></li> <li>Select Bear
<ol><li>Select 0</li></ol></li> <li>Delete Bear</li> <li>Add Comment
<ol><li>The size of the comment must be <code>0xb8-1</code>, so that we <code>calloc(0xb8,1)</code> and so that it will reuse the free memory that belonged to <code>bears[0]</code></li> <li>We can send <code>0xb0</code> arbitrary bytes, then send our desired function pointer, let's say, <code>0xcafebabe</code></li></ol></li> <li>We call Build Bear 12 more times
<ol><li>Put arbitrary data again</li></ol></li> <li>Build Bear (we already have 13 bears, this will go to the secret section now)
<ol><li>This time, we send <code>SUNIATRETNE</code> in reverse, and this will set admin_enabled to 1</li></ol></li> <li>Destruction</li></ol> <p>Now the question is, what do we want to execute?</p> <p>There isn't any function that can give shell, and we don't know the address of any function since it is a PIE binary anyway</p> <div class="language- extra-class"><pre class="language-text"><code>$ checksec gruffybear
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
</code></pre></div><p>Lets go hunting for a leak!</p> <p>Actually thats really easy, since we are freeing a <a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/bins_chunks.html" target="_blank" rel="noopener noreferrer">smallbin-sized chunk (0xb8 = 184)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. If you see the structure of a free malloc_chunk in the smallbin size range, the first 8 bytes are a pointer to the smallbin, called <a href="https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/malloc_chunk.html" target="_blank" rel="noopener noreferrer">fd<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which are the first 8 bytes of the bear's name.
To do this, we need to allocate another chunk first (build another bear) so that the chunk above ours is not the top chunk.</p> <p>We can use <code>print_bear()</code> to leak this address, then call a libc function.</p> <p>So now, do we call system()? We can't though, since we are passing the num_bears as its argument. Instead, we can use something called 'magic gadgets', which are places in libc we can jump to so that we can instantly get shell as long as some constraints are valid.</p> <p>I use the tool <code>one_gadget</code> to do this.</p> <div class="language- extra-class"><pre class="language-text"><code>$ one_gadget libc-2.23.so
0x45216	execve(&quot;/bin/sh&quot;, rsp+0x30, environ)
constraints:
  rax == NULL

0x4526a	execve(&quot;/bin/sh&quot;, rsp+0x30, environ)
constraints:
  [rsp+0x30] == NULL

0xf02a4	execve(&quot;/bin/sh&quot;, rsp+0x50, environ)
constraints:
  [rsp+0x50] == NULL

0xf1147	execve(&quot;/bin/sh&quot;, rsp+0x70, environ)
constraints:
  [rsp+0x70] == NULL
</code></pre></div><p>I chose the second last one (it was at random)</p> <p>So now, our steps are as follows</p> <ol><li>Build Bear
<ol><li>Put arbitrary data</li></ol></li> <li>Build Bear
<ol><li>Put arbitrary data</li></ol></li> <li>Select Bear
<ol><li>Select 0</li></ol></li> <li>Delete Bear</li> <li>Print Bear
<ol><li>This will give us the libc smallbin address for size 0xb8 (in the name)</li> <li>This address is also 0x70+__realloc_hook, which was the calculation I used</li></ol></li> <li>Add Comment
<ol><li>The size of the comment must be <code>0xb8-1</code>, so that we <code>calloc(0xb8,1)</code> and so that it will reuse the free memory that belonged to <code>bears[0]</code></li> <li>We can send <code>0xb0</code> arbitrary bytes, then send our desired function pointer, which is <code>libc_base+0xf02a4</code></li> <li>It only reads in 0xb7 bytes, so remember to remove the last byte from the input (its a null byte anyway)</li></ol></li> <li>We call Build Bear 11 more times
<ol><li>Put arbitrary data again</li></ol></li> <li>Build Bear (we already have 13 bears, this will go to the secret section now)
<ol><li>This time, we send <code>SUNIATRETNE</code> in reverse, and this will set admin_enabled to 1</li></ol></li> <li>Destruction</li></ol> <p>The final solution is in <a href="./gruffybear.py">here</a></p></div></div>  <div><div id="disqus_box"><div id="disqus_thread"></div> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e91e0d74.js" defer></script><script src="/assets/js/12.e9130249.js" defer></script><script src="/assets/js/3.0adb0de5.js" defer></script><script src="/assets/js/2.e61d4284.js" defer></script><script src="/assets/js/8.d74ac80a.js" defer></script><script src="/assets/js/7.646cabab.js" defer></script><script src="/assets/js/17.aede9271.js" defer></script><script src="/assets/js/11.e9277445.js" defer></script>
  </body>
</html>
